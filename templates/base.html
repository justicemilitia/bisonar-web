<!DOCTYPE html>
<html lang="en" class="scroll-smooth dark">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/static/images/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}Bisonar | AI Automation & Intelligent Workflows{% endblock %}</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/css/style.css">
    
    <!-- Horizontal Scroll Fix -->
    <style>
        /* EMERGENCY FIX FOR HORIZONTAL SCROLL */
        html, body {
            margin: 0 !important;
            padding: 0 !important;
            overflow-x: hidden !important;
            position: relative !important;
            left: 0 !important;
            width: 100% !important;
            max-width: 100% !important;
        }
        
        * {
            box-sizing: border-box;
        }

        /* CHATBOT STYLES */
        .chatbot-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .chatbot-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.3s ease;
        }

        .chatbot-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
        }

        .chatbot-container {
            position: absolute;
            bottom: 70px;
            right: 0;
            width: 380px;
            height: 500px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border: 1px solid #e0e0e0;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .chatbot-container.open {
            display: flex;
        }

        .chatbot-header {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chatbot-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }

        .close-chatbot {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chatbot-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 85%;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .user-message {
            background: #007bff;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .bot-message {
            background: white;
            border: 1px solid #e0e0e0;
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }

        .chatbot-quick-replies {
            padding: 15px;
            border-top: 1px solid #e0e0e0;
            background: white;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .quick-reply-btn {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 20px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .quick-reply-btn:hover {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .chatbot-input-container {
            padding: 15px;
            border-top: 1px solid #e0e0e0;
            background: white;
            display: flex;
            gap: 10px;
        }

        .chatbot-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
            font-size: 14px;
        }

        .chatbot-input:focus {
            border-color: #007bff;
        }

        .send-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .send-button:hover {
            background: #0056b3;
        }

        .send-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="leading-relaxed overflow-x-hidden">
    {% block content %}{% endblock %}
    
    <!-- CHATBOT WIDGET -->
    <div class="chatbot-widget">
        <button class="chatbot-button" onclick="toggleChatbot()">
            🤖
        </button>
        <div class="chatbot-container" id="chatbotContainer">
            <div class="chatbot-header">
                <h3>AI Danışmanlık Asistanı</h3>
                <button class="close-chatbot" onclick="toggleChatbot()">×</button>
            </div>
            <div class="chatbot-messages" id="chatbotMessages">
                <div class="chat-message bot-message">
                    👋 Merhaba! Bisonar AI Asistanına hoş geldiniz. Size nasıl yardımcı olabilirim?
                </div>
            </div>
            <div class="chatbot-quick-replies" id="chatbotQuickReplies">
                <button class="quick-reply-btn" onclick="sendQuickReply('n8n otomasyonu')">n8n Otomasyonu</button>
                <button class="quick-reply-btn" onclick="sendQuickReply('AI iş akışları')">AI İş Akışları</button>
                <button class="quick-reply-btn" onclick="sendQuickReply('danışmanlık hizmetleri')">Danışmanlık</button>
                <button class="quick-reply-btn" onclick="sendQuickReply('fiyat bilgisi')">Fiyat Bilgisi</button>
            </div>
            <div class="chatbot-input-container">
                <input type="text" class="chatbot-input" id="chatbotInput" placeholder="Mesajınızı yazın..." onkeypress="handleChatbotKeyPress(event)">
                <button class="send-button" onclick="sendChatbotMessage()">Gönder</button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="/static/js/main.js"></script>
    
    <!-- CHATBOT JAVASCRIPT -->
<script>
// CHATBOT JAVASCRIPT - FLASK API ÜZERİNDEN
let sessionId = '';
let userId = 'web_user_' + Date.now();

// Cookie fonksiyonları
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
}

function setCookie(name, value, days = 30) {
    const date = new Date();
    date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
    const expires = `expires=${date.toUTCString()}`;
    document.cookie = `${name}=${value}; ${expires}; path=/; SameSite=Lax`;
}

function generateSessionId() {
    return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

// Session ID'yi başlat
function initializeSession() {
    // Mevcut session ID'yi kontrol et
    sessionId = getCookie('bisonar_session_id');
    if (!sessionId) {
        sessionId = generateSessionId();
        setCookie('bisonar_session_id', sessionId);
        console.log('🆕 Yeni oturum başlatıldı:', sessionId);
    } else {
        console.log('📚 Mevcut oturum devam ediyor:', sessionId);
    }
}

// Sayfa yüklendiğinde session'ı başlat
document.addEventListener('DOMContentLoaded', function() {
    initializeSession();
    const chatbotInput = document.getElementById('chatbotInput');
    if (chatbotInput) {
        chatbotInput.focus();
    }
});

function toggleChatbot() {
    const container = document.getElementById('chatbotContainer');
    container.classList.toggle('open');
    
    // Chatbot açıldığında input'a focus
    if (container.classList.contains('open')) {
        setTimeout(() => {
            const chatbotInput = document.getElementById('chatbotInput');
            if (chatbotInput) {
                chatbotInput.focus();
            }
        }, 300);
    }
}

async function sendChatbotMessage() {
    const input = document.getElementById('chatbotInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    addChatbotMessage('Siz', message, 'user');
    input.value = '';
    
    // Loading state
    input.disabled = true;
    document.querySelector('.send-button').disabled = true;
    document.querySelector('.send-button').textContent = '...';
    
    // Clear quick replies
    document.getElementById('chatbotQuickReplies').innerHTML = '';
    
    try {
        // ✅ FLASK API'ye istek yap (CORS hatası olmaz)
        const response = await fetch('/api/chatbot', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: message,
                sessionId: sessionId,
                userId: userId
            })
        });
        
        if (response.ok) {
            const data = await response.json();
            console.log('✅ Flask API Başarılı:', data);
            
            let aiResponse = "Cevap alınamadı";
            let quickReplies = ['n8n Otomasyonu', 'AI İş Akışları', 'Danışmanlık', 'Fiyat Bilgisi'];
            
            if (typeof data === 'object') {
                if (data.response) {
                    aiResponse = data.response;
                } 
                else if (Array.isArray(data) && data.length > 0 && data[0].response) {
                    aiResponse = data[0].response;
                    if (data[0].quickReplies) {
                        quickReplies = data[0].quickReplies;
                    }
                }
                else if (data.message) {
                    aiResponse = data.message;
                } else if (data.text) {
                    aiResponse = data.text;
                }
                
                if (data.quickReplies && Array.isArray(data.quickReplies)) {
                    quickReplies = data.quickReplies;
                } else if (Array.isArray(data) && data[0] && data[0].quickReplies) {
                    quickReplies = data[0].quickReplies;
                }
            }
            
            console.log('📝 AI Response:', aiResponse);
            console.log('🔘 Quick Replies:', quickReplies);
            
            addChatbotMessage('AI Asistan', aiResponse, 'bot');
            showChatbotQuickReplies(quickReplies);
            
        } else {
            throw new Error(`API hatası: ${response.status}`);
        }
        
    } catch (error) {
        console.error('API hatası:', error);
        
        // ✅ FALLBACK DEMO MODU
        addChatbotMessage('AI Asistan', '🤖 ' + getDemoResponse(message), 'bot');
        showChatbotQuickReplies(['n8n Otomasyonu', 'AI İş Akışları', 'Danışmanlık', 'Fiyat Bilgisi']);
        
    } finally {
        input.disabled = false;
        document.querySelector('.send-button').disabled = false;
        document.querySelector('.send-button').textContent = 'Gönder';
        input.focus();
    }
}

// Local demo yanıtları (fallback için)
function getDemoResponse(message) {
    const lowerMessage = message.toLowerCase();
    if (lowerMessage.includes('n8n')) return '🚀 n8n otomasyon hizmetlerimizle iş süreçlerinizi otomatikleştirin!';
    if (lowerMessage.includes('ai')) return '🤖 AI iş akışları ile verimliliğinizi artırın!';
    if (lowerMessage.includes('danışmanlık')) return '💼 Danışmanlık hizmetlerimizle size özel çözümler sunuyoruz!';
    return 'Size nasıl yardımcı olabilirim? n8n otomasyonu, AI iş akışları veya danışmanlık hakkında bilgi alabilirsiniz.';
}

function sendQuickReply(message) {
    document.getElementById('chatbotInput').value = message;
    sendChatbotMessage();
}

function addChatbotMessage(sender, text, type) {
    const messagesContainer = document.getElementById('chatbotMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${type}-message`;
    messageDiv.innerHTML = `<strong>${sender}:</strong> ${text}`;
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function showChatbotQuickReplies(replies) {
    const quickRepliesContainer = document.getElementById('chatbotQuickReplies');
    quickRepliesContainer.innerHTML = '';
    
    if (replies && Array.isArray(replies)) {
        replies.forEach(reply => {
            const button = document.createElement('button');
            button.className = 'quick-reply-btn';
            button.textContent = reply;
            button.onclick = () => sendQuickReply(reply);
            quickRepliesContainer.appendChild(button);
        });
    }
}

function handleChatbotKeyPress(e) {
    if (e.key === 'Enter') {
        sendChatbotMessage();
    }
}
</script>
    {% block extra_js %}{% endblock %}
</body>
</html>