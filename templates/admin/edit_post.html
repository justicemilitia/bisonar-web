{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-gray-50 dark:bg-gray-900 py-8">
    <div class="container mx-auto px-6 max-w-6xl">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
                {% if post %}Edit Post{% else %}New Post{% endif %}
            </h1>
            <p class="text-gray-600 dark:text-gray-400">
                {% if post %}Update your blog post{% else %}Create a new blog post{% endif %}
            </p>
        </div>

        <!-- AI Generation Section - SADECE YENƒ∞ POST ƒ∞√áƒ∞N G√ñSTER -->
        {% if not post %}
        <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-6 mb-6">
            <h3 class="text-lg font-semibold text-blue-900 dark:text-blue-100 mb-2">
                üöÄ AI ile Blog Yazƒ±sƒ± Olu≈ütur
            </h3>
            <p class="text-blue-700 dark:text-blue-300 mb-4">
                Konuyu girerek AI destekli blog yazƒ±sƒ± olu≈üturabilirsiniz.
            </p>
            
            <div class="flex flex-col md:flex-row gap-4">
                <input type="text" id="ai-topic" 
                       placeholder="√ñrn: n8n workflow optimization, ChatGPT entegrasyonu..."
                       class="flex-1 px-3 py-2 border border-blue-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                
                <select id="ai-language" class="px-3 py-2 border border-blue-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                    <option value="en">English</option>
                    <option value="tr" selected>T√ºrk√ße</option>
                </select>
                
                <button onclick="generateWithAI()" 
                        class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md font-semibold transition-colors flex items-center gap-2">
                    <span id="ai-loading" class="hidden">‚è≥</span>
                    AI ile Olu≈ütur
                </button>
            </div>
            <div id="ai-error" class="text-red-600 dark:text-red-400 mt-2 hidden"></div>
        </div>
        {% endif %}

        <!-- Form -->
        <form method="POST" enctype="multipart/form-data" class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 space-y-6">
            <!-- Title -->
            <div>
                <label for="title" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Title *
                </label>
                <input type="text" id="title" name="title" value="{{ post.title if post }}" 
                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                       required>
            </div>

            <!-- Slug -->
            <div>
                <label for="slug" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Slug *
                </label>
                <input type="text" id="slug" name="slug" value="{{ post.slug if post }}" 
                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                       required>
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">URL-friendly version of the title</p>
            </div>

            <!-- Excerpt -->
            <div>
                <label for="excerpt" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Excerpt *
                </label>
                <textarea id="excerpt" name="excerpt" rows="3"
                          class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                          required>{{ post.excerpt if post }}</textarea>
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Brief description for preview</p>
            </div>

            <!-- Content Editor -->
            <div>
                <div class="flex justify-between items-center mb-2">
                    <label for="content" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                        Content *
                    </label>
                    <div class="flex space-x-2">
                        <button type="button" onclick="togglePreview()" 
                                class="px-3 py-1 text-xs bg-gray-200 dark:bg-gray-700 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                            Preview
                        </button>
                        <button type="button" onclick="insertMarkdown('bold')" 
                                class="px-2 py-1 text-xs bg-gray-200 dark:bg-gray-700 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                            <strong>B</strong>
                        </button>
                        <button type="button" onclick="insertMarkdown('italic')" 
                                class="px-2 py-1 text-xs bg-gray-200 dark:bg-gray-700 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                            <em>I</em>
                        </button>
                        <button type="button" onclick="insertMarkdown('link')" 
                                class="px-2 py-1 text-xs bg-gray-200 dark:bg-gray-700 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                            üîó
                        </button>
                        <button type="button" onclick="insertMarkdown('image')" 
                                class="px-2 py-1 text-xs bg-gray-200 dark:bg-gray-700 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                            üñºÔ∏è
                        </button>
                        <button type="button" onclick="insertMarkdown('code')" 
                                class="px-2 py-1 text-xs bg-gray-200 dark:bg-gray-700 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                            { }
                        </button>
                    </div>
                </div>
                
                <!-- Editor Container -->
                <div class="border border-gray-300 dark:border-gray-600 rounded-md overflow-hidden">
                    <!-- Toolbar -->
                    <div class="bg-gray-100 dark:bg-gray-700 px-4 py-2 border-b border-gray-300 dark:border-gray-600 flex flex-wrap gap-2">
                        <button type="button" onclick="formatText('bold')" class="px-2 py-1 hover:bg-gray-200 dark:hover:bg-gray-600 rounded">
                            <strong>B</strong>
                        </button>
                        <button type="button" onclick="formatText('italic')" class="px-2 py-1 hover:bg-gray-200 dark:hover:bg-gray-600 rounded">
                            <em>I</em>
                        </button>
                        <button type="button" onclick="formatText('heading1')" class="px-2 py-1 hover:bg-gray-200 dark:hover:bg-gray-600 rounded">
                            H1
                        </button>
                        <button type="button" onclick="formatText('heading2')" class="px-2 py-1 hover:bg-gray-200 dark:hover:bg-gray-600 rounded">
                            H2
                        </button>
                        <button type="button" onclick="formatText('blockquote')" class="px-2 py-1 hover:bg-gray-200 dark:hover:bg-gray-600 rounded">
                            ‚ùù
                        </button>
                        <button type="button" onclick="formatText('code')" class="px-2 py-1 hover:bg-gray-200 dark:hover:bg-gray-600 rounded">
                            { }
                        </button>
                        <button type="button" onclick="formatText('link')" class="px-2 py-1 hover:bg-gray-200 dark:hover:bg-gray-600 rounded">
                            üîó
                        </button>
                        <button type="button" onclick="formatText('image')" class="px-2 py-1 hover:bg-gray-200 dark:hover:bg-gray-600 rounded">
                            üñºÔ∏è
                        </button>
                        <button type="button" onclick="formatText('ul')" class="px-2 py-1 hover:bg-gray-200 dark:hover:bg-gray-600 rounded">
                            ‚Ä¢ List
                        </button>
                        <button type="button" onclick="formatText('ol')" class="px-2 py-1 hover:bg-gray-200 dark:hover:bg-gray-600 rounded">
                            1. List
                        </button>
                    </div>
                    
                    <!-- Editor and Preview Panes -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 p-4" id="editor-container">
                        <!-- Editor Pane -->
                        <div class="lg:col-span-1">
                            <textarea id="content" name="content" rows="20"
                                      class="w-full h-full px-3 py-2 border-0 focus:outline-none focus:ring-0 dark:bg-gray-800 dark:text-white font-mono text-sm resize-none"
                                      placeholder="Write your content in Markdown..."
                                      required>{{ post.content if post }}</textarea>
                        </div>
                        
                        <!-- Preview Pane -->
                        <div class="lg:col-span-1 hidden" id="preview-pane">
                            <div class="prose dark:prose-invert max-w-none bg-white dark:bg-gray-800 p-4 rounded border">
                                <div id="preview-content"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Markdown supported. Use the toolbar for quick formatting.</p>
            </div>

            <!-- Author & Read Time -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="author" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Author *
                    </label>
                    <input type="text" id="author" name="author" value="{{ post.author if post else 'Bisonar Team' }}" 
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                           required>
                </div>
                <div>
                    <label for="read_time" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Read Time *
                    </label>
                    <input type="text" id="read_time" name="read_time" value="{{ post.read_time if post else '5 min read' }}" 
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                           required>
                </div>
            </div>

            <!-- Image -->
            <div>
                <label for="image" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Featured Image
                </label>
                {% if post and post.image_url %}
                <div class="mb-4">
                    <img src="{{ post.image_url }}" alt="Current image" class="h-32 w-auto rounded-lg">
                    <input type="hidden" name="current_image" value="{{ post.image_url }}">
                </div>
                {% endif %}
                <input type="file" id="image" name="image" 
                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700"
                       accept="image/*">
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">PNG, JPG, GIF up to 5MB</p>
            </div>

            <!-- Publish -->
            <div class="flex items-center">
                <input type="checkbox" id="is_published" name="is_published" 
                       {% if post and post.is_published or not post %}checked{% endif %}
                       class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                <label for="is_published" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">
                    Publish immediately
                </label>
            </div>

            <!-- Actions -->
            <div class="flex justify-end space-x-4 pt-6 border-t border-gray-200 dark:border-gray-700">
                <a href="{{ url_for('admin_dashboard') }}" class="px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                    Cancel
                </a>
                <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md font-semibold transition-colors">
                    {% if post %}Update Post{% else %}Create Post{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Include Marked.js for Markdown parsing -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
// Auto-generate slug from title
document.getElementById('title').addEventListener('input', function() {
    const slugInput = document.getElementById('slug');
    if (!slugInput.value) {
        const slug = this.value
            .toLowerCase()
            .replace(/[^a-z0-9 -]/g, '')
            .replace(/\s+/g, '-')
            .replace(/-+/g, '-');
        slugInput.value = slug;
    }
});

// Editor Functions
function formatText(type) {
    const textarea = document.getElementById('content');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);
    
    let formattedText = '';
    
    switch(type) {
        case 'bold':
            formattedText = `**${selectedText}**`;
            break;
        case 'italic':
            formattedText = `*${selectedText}*`;
            break;
        case 'heading1':
            formattedText = `# ${selectedText}`;
            break;
        case 'heading2':
            formattedText = `## ${selectedText}`;
            break;
        case 'blockquote':
            formattedText = `> ${selectedText}`;
            break;
        case 'code':
            formattedText = `\`${selectedText}\``;
            break;
        case 'link':
            formattedText = `[${selectedText}](https://)`;
            break;
        case 'image':
            formattedText = `![${selectedText}](https://)`;
            break;
        case 'ul':
            formattedText = selectedText.split('\n').map(line => `- ${line}`).join('\n');
            break;
        case 'ol':
            formattedText = selectedText.split('\n').map((line, index) => `${index + 1}. ${line}`).join('\n');
            break;
    }
    
    textarea.value = textarea.value.substring(0, start) + formattedText + textarea.value.substring(end);
    textarea.focus();
    updatePreview();
}

function togglePreview() {
    const previewPane = document.getElementById('preview-pane');
    const editorContainer = document.getElementById('editor-container');
    
    if (previewPane.classList.contains('hidden')) {
        previewPane.classList.remove('hidden');
        editorContainer.classList.remove('lg:grid-cols-2');
        editorContainer.classList.add('lg:grid-cols-1');
        updatePreview();
    } else {
        previewPane.classList.add('hidden');
        editorContainer.classList.remove('lg:grid-cols-1');
        editorContainer.classList.add('lg:grid-cols-2');
    }
}

function updatePreview() {
    const content = document.getElementById('content').value;
    const previewContent = document.getElementById('preview-content');
    previewContent.innerHTML = marked.parse(content);
}

// Auto-update preview when typing
document.getElementById('content').addEventListener('input', updatePreview);

// AI Generation Function
async function generateWithAI() {
    const topicInput = document.getElementById('ai-topic');
    const languageSelect = document.getElementById('ai-language');
    const loadingElement = document.getElementById('ai-loading');
    const errorElement = document.getElementById('ai-error');
    
    const topic = topicInput.value.trim();
    const language = languageSelect.value;
    
    if (!topic) {
        errorElement.textContent = 'L√ºtfen bir konu girin';
        errorElement.classList.remove('hidden');
        return;
    }
    
    loadingElement.classList.remove('hidden');
    errorElement.classList.add('hidden');
    
    try {
        const response = await fetch('/admin/generate-blog', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                topic: topic,
                language: language
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            if (data.error) {
                throw new Error(data.error);
            } else {
                // Fill form with AI generated content
                document.getElementById('title').value = data.title || '';
                document.getElementById('slug').value = data.slug || data.title
                    .toLowerCase()
                    .replace(/[^a-z0-9 -]/g, '')
                    .replace(/\s+/g, '-')
                    .replace(/-+/g, '-');
                document.getElementById('excerpt').value = data.excerpt || '';
                document.getElementById('content').value = data.content || '';
                document.getElementById('read_time').value = data.read_time || '5 min read';
                document.getElementById('author').value = data.author || 'Bisonar AI';
                
                // Update preview
                updatePreview();
                
                // Show success message
                errorElement.textContent = '‚úÖ AI i√ßeriƒüi ba≈üarƒ±yla olu≈üturuldu!';
                errorElement.classList.remove('hidden');
                errorElement.classList.remove('text-red-600');
                errorElement.classList.add('text-green-600');
            }
            
        } else {
            throw new Error(data.error || `HTTP ${response.status} - AI servisi ≈üu anda m√ºsait deƒüil`);
        }
        
    } catch (error) {
        errorElement.textContent = 'Hata: ' + error.message;
        errorElement.classList.remove('hidden');
        errorElement.classList.remove('text-green-600');
        errorElement.classList.add('text-red-600');
    } finally {
        loadingElement.classList.add('hidden');
    }
}

// Initialize preview on load
document.addEventListener('DOMContentLoaded', function() {
    updatePreview();
});
</script>

<style>
.prose {
    max-width: none;
}
.prose h1 {
    font-size: 2em;
    font-weight: bold;
    margin-top: 1em;
    margin-bottom: 0.5em;
}
.prose h2 {
    font-size: 1.5em;
    font-weight: bold;
    margin-top: 1em;
    margin-bottom: 0.5em;
}
.prose blockquote {
    border-left: 4px solid #e5e7eb;
    padding-left: 1em;
    font-style: italic;
    margin: 1em 0;
}
.prose code {
    background-color: #f3f4f6;
    padding: 0.125em 0.25em;
    border-radius: 0.25em;
    font-family: monospace;
}
.prose pre {
    background-color: #1f2937;
    color: white;
    padding: 1em;
    border-radius: 0.5em;
    overflow-x: auto;
}
.prose ul {
    list-style-type: disc;
    padding-left: 1.5em;
}
.prose ol {
    list-style-type: decimal;
    padding-left: 1.5em;
}
</style>
{% endblock %}