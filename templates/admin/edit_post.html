{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-gray-50 dark:bg-gray-900 py-8">
    <div class="container mx-auto px-6 max-w-6xl">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
                {% if post %}Edit Post{% else %}New Post{% endif %}
            </h1>
            <p class="text-gray-600 dark:text-gray-400">
                {% if post %}Update your blog post{% else %}Create a new blog post{% endif %}
            </p>
        </div>

        <!-- AI Generation Section - SADECE YENƒ∞ POST ƒ∞√áƒ∞N G√ñSTER -->
        {% if not post %}
        <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-6 mb-6">
            <h3 class="text-lg font-semibold text-blue-900 dark:text-blue-100 mb-2">
                üöÄ AI ile Blog Yazƒ±sƒ± Olu≈ütur
            </h3>
            <p class="text-blue-700 dark:text-blue-300 mb-4">
                Konuyu girerek AI destekli blog yazƒ±sƒ± olu≈üturabilirsiniz.
            </p>
            
            <div class="flex flex-col md:flex-row gap-4">
                <input type="text" id="ai-topic" 
                       placeholder="√ñrn: n8n workflow optimization, ChatGPT entegrasyonu..."
                       class="flex-1 px-3 py-2 border border-blue-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                
                <select id="ai-language" class="px-3 py-2 border border-blue-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                    <option value="en">English</option>
                    <option value="tr" selected>T√ºrk√ße</option>
                </select>
                
                <button onclick="generateWithAI()" 
                        class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md font-semibold transition-colors flex items-center gap-2">
                    <span id="ai-loading" class="hidden">‚è≥</span>
                    AI ile Olu≈ütur
                </button>
            </div>
            <div id="ai-error" class="text-red-600 dark:text-red-400 mt-2 hidden"></div>
        </div>
        {% endif %}

        <!-- Form -->
        <form method="POST" enctype="multipart/form-data" class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 space-y-6">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <!-- Language Selection -->
            <div>
                <label for="language" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Dil / Language *
                </label>
                <select name="language" id="language" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" required>
                    <option value="en" {% if post and post.language == 'en' %}selected{% endif %}>English</option>
                    <option value="tr" {% if post and post.language == 'tr' %}selected{% endif %}>T√ºrk√ße</option>
                </select>
            </div>

            <!-- English Content Section -->
            <div class="border-l-4 border-blue-500 pl-4 bg-blue-50 dark:bg-blue-900/20 p-4 rounded">
                <h3 class="text-lg font-semibold text-blue-900 dark:text-blue-100 mb-4">üá∫üá∏ English Content</h3>
                
                <!-- English Title -->
                <div class="mb-4">
                    <label for="title_en" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        English Title *
                    </label>
                    <input type="text" id="title_en" name="title_en" 
                           value="{{ post.title_en if post }}" 
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                           required>
                </div>

                <!-- English Slug -->
                <div class="mb-4">
                    <label for="slug_en" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        English Slug *
                    </label>
                    <input type="text" id="slug_en" name="slug_en" 
                           value="{{ post.slug_en if post }}" 
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                           required>
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">URL-friendly version for English</p>
                </div>

                <!-- English Excerpt -->
                <div class="mb-4">
                    <label for="excerpt_en" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        English Excerpt *
                    </label>
                    <textarea id="excerpt_en" name="excerpt_en" rows="3"
                              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                              required>{{ post.excerpt_en if post }}</textarea>
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Brief description for English preview</p>
                </div>

                <!-- English Content -->
                <div class="mb-4">
                    <label for="content_en" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        English Content *
                    </label>
                    <textarea id="content_en" name="content_en" rows="10"
                              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white font-mono text-sm"
                              placeholder="Write your English content in Markdown..."
                              required>{{ post.content_en if post }}</textarea>
                </div>
            </div>

            <!-- Turkish Content Section -->
            <div class="border-l-4 border-red-500 pl-4 bg-red-50 dark:bg-red-900/20 p-4 rounded">
                <h3 class="text-lg font-semibold text-red-900 dark:text-red-100 mb-4">üáπüá∑ T√ºrk√ße ƒ∞√ßerik</h3>
                
                <!-- Turkish Title -->
                <div class="mb-4">
                    <label for="title_tr" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        T√ºrk√ße Ba≈ülƒ±k *
                    </label>
                    <input type="text" id="title_tr" name="title_tr" 
                           value="{{ post.title_tr if post }}" 
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                           required>
                </div>

                <!-- Turkish Slug -->
                <div class="mb-4">
                    <label for="slug_tr" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        T√ºrk√ße Slug *
                    </label>
                    <input type="text" id="slug_tr" name="slug_tr" 
                           value="{{ post.slug_tr if post }}" 
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                           required>
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">URL-friendly version for Turkish</p>
                </div>

                <!-- Turkish Excerpt -->
                <div class="mb-4">
                    <label for="excerpt_tr" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        T√ºrk√ße √ñzet *
                    </label>
                    <textarea id="excerpt_tr" name="excerpt_tr" rows="3"
                              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                              required>{{ post.excerpt_tr if post }}</textarea>
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">T√ºrk√ße √∂nizleme i√ßin kƒ±sa a√ßƒ±klama</p>
                </div>

                <!-- Turkish Content -->
                <div class="mb-4">
                    <label for="content_tr" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        T√ºrk√ße ƒ∞√ßerik *
                    </label>
                    <textarea id="content_tr" name="content_tr" rows="10"
                              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white font-mono text-sm"
                              placeholder="T√ºrk√ße i√ßeriƒüinizi Markdown formatƒ±nda yazƒ±n..."
                              required>{{ post.content_tr if post }}</textarea>
                </div>
            </div>

            <!-- Common Fields -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="author" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Author *
                    </label>
                    <input type="text" id="author" name="author" value="{{ post.author if post else 'Bisonar Team' }}" 
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                           required>
                </div>
                <div>
                    <label for="read_time" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Read Time *
                    </label>
                    <input type="text" id="read_time" name="read_time" value="{{ post.read_time if post else '5 min read' }}" 
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                           required>
                </div>
            </div>

            <!-- Image -->
            <div>
                <label for="image" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Featured Image
                </label>
                {% if post and post.image_url %}
                <div class="mb-4">
                    <img src="{{ post.image_url }}" alt="Current image" class="h-32 w-auto rounded-lg">
                    <input type="hidden" name="current_image" value="{{ post.image_url }}">
                </div>
                {% endif %}
                <input type="file" id="image" name="image" 
                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700"
                       accept="image/*">
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">PNG, JPG, GIF up to 5MB</p>
            </div>

            <!-- Publish -->
            <div class="flex items-center">
                <input type="checkbox" id="is_published" name="is_published" 
                       {% if post and post.is_published or not post %}checked{% endif %}
                       class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                <label for="is_published" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">
                    Publish immediately
                </label>
            </div>

            <!-- Actions -->
            <div class="flex justify-end space-x-4 pt-6 border-t border-gray-200 dark:border-gray-700">
                <a href="{{ url_for('admin_dashboard') }}" class="px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                    Cancel
                </a>
                <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md font-semibold transition-colors">
                    {% if post %}Update Post{% else %}Create Post{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Auto-generate slugs from titles
document.getElementById('title_en').addEventListener('input', function() {
    const slugInput = document.getElementById('slug_en');
    if (!slugInput.value) {
        const slug = this.value
            .toLowerCase()
            .replace(/[^a-z0-9 -]/g, '')
            .replace(/\s+/g, '-')
            .replace(/-+/g, '-')
            .replace(/^-+/, '')
            .replace(/-+$/, '');
        slugInput.value = slug;
    }
});

document.getElementById('title_tr').addEventListener('input', function() {
    const slugInput = document.getElementById('slug_tr');
    if (!slugInput.value) {
        // Turkish character handling - improved version
        const slug = this.value
            .toLowerCase()
            .replace(/[^a-z0-9√ßƒüƒ±√∂≈ü√º -]/g, '')  // T√ºrk√ße karakterlere izin ver
            .replace(/√ß/g, 'c')
            .replace(/ƒü/g, 'g')
            .replace(/ƒ±/g, 'i')
            .replace(/√∂/g, 'o')
            .replace(/≈ü/g, 's')
            .replace(/√º/g, 'u')
            .replace(/\s+/g, '-')
            .replace(/-+/g, '-')
            .replace(/^-+/, '')   // Ba≈ütaki tireleri temizle
            .replace(/-+$/, '');  // Sondaki tireleri temizle
        slugInput.value = slug;
    }
});

// AI Generation Function - G√úNCELLENMƒ∞≈û
async function generateWithAI() {
    const topicInput = document.getElementById('ai-topic');
    const languageSelect = document.getElementById('ai-language');
    const loadingElement = document.getElementById('ai-loading');
    const errorElement = document.getElementById('ai-error');
    
    const topic = topicInput.value.trim();
    const language = languageSelect.value;
    
    if (!topic) {
        errorElement.textContent = 'L√ºtfen bir konu girin';
        errorElement.classList.remove('hidden');
        return;
    }
    
    loadingElement.classList.remove('hidden');
    errorElement.classList.add('hidden');
    
    try {
        const response = await fetch('/admin/generate-blog', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                topic: topic,
                language: language
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            if (data.error) {
                throw new Error(data.error);
            } else {
                // Fill form with AI generated content based on language
                if (language === 'en') {
                    document.getElementById('title_en').value = data.title || '';
                    document.getElementById('slug_en').value = data.slug || data.title
                        .toLowerCase()
                        .replace(/[^a-z0-9 -]/g, '')
                        .replace(/\s+/g, '-')
                        .replace(/-+/g, '-')
                        .replace(/^-+/, '')
                        .replace(/-+$/, '');
                    document.getElementById('excerpt_en').value = data.excerpt || '';
                    document.getElementById('content_en').value = data.content || '';
                    
                    // Auto-translate title for Turkish with proper slug
                    document.getElementById('title_tr').value = data.title + ' (TR)';
                    const turkishSlug = (data.slug || data.title)
                        .toLowerCase()
                        .replace(/[^a-z0-9√ßƒüƒ±√∂≈ü√º -]/g, '')
                        .replace(/√ß/g, 'c')
                        .replace(/ƒü/g, 'g')
                        .replace(/ƒ±/g, 'i')
                        .replace(/√∂/g, 'o')
                        .replace(/≈ü/g, 's')
                        .replace(/√º/g, 'u')
                        .replace(/\s+/g, '-')
                        .replace(/-+/g, '-')
                        .replace(/^-+/, '')
                        .replace(/-+$/, '');
                    document.getElementById('slug_tr').value = turkishSlug + '-tr';
                } else {
                    document.getElementById('title_tr').value = data.title || '';
                    const turkishSlug = (data.slug || data.title)
                        .toLowerCase()
                        .replace(/[^a-z0-9√ßƒüƒ±√∂≈ü√º -]/g, '')
                        .replace(/√ß/g, 'c')
                        .replace(/ƒü/g, 'g')
                        .replace(/ƒ±/g, 'i')
                        .replace(/√∂/g, 'o')
                        .replace(/≈ü/g, 's')
                        .replace(/√º/g, 'u')
                        .replace(/\s+/g, '-')
                        .replace(/-+/g, '-')
                        .replace(/^-+/, '')
                        .replace(/-+$/, '');
                    document.getElementById('slug_tr').value = turkishSlug;
                    document.getElementById('excerpt_tr').value = data.excerpt || '';
                    document.getElementById('content_tr').value = data.content || '';
                    
                    // Auto-translate title for English
                    document.getElementById('title_en').value = data.title + ' (EN)';
                    document.getElementById('slug_en').value = (data.slug || data.title
                        .toLowerCase()
                        .replace(/[^a-z0-9 -]/g, '')
                        .replace(/\s+/g, '-')
                        .replace(/-+/g, '-')
                        .replace(/^-+/, '')
                        .replace(/-+$/, '')) + '-en';
                }
                
                document.getElementById('read_time').value = data.read_time || '5 min read';
                document.getElementById('author').value = data.author || 'Bisonar AI';
                document.getElementById('language').value = language;
                
                // Show success message
                errorElement.textContent = '‚úÖ AI i√ßeriƒüi ba≈üarƒ±yla olu≈üturuldu!';
                errorElement.classList.remove('hidden');
                errorElement.classList.remove('text-red-600');
                errorElement.classList.add('text-green-600');
            }
            
        } else {
            throw new Error(data.error || `HTTP ${response.status} - AI servisi ≈üu anda m√ºsait deƒüil`);
        }
        
    } catch (error) {
        errorElement.textContent = 'Hata: ' + error.message;
        errorElement.classList.remove('hidden');
        errorElement.classList.remove('text-green-600');
        errorElement.classList.add('text-red-600');
    } finally {
        loadingElement.classList.add('hidden');
    }
}

// Auto-fill both languages when one title is entered
function setupTitleSync() {
    const titleEn = document.getElementById('title_en');
    const titleTr = document.getElementById('title_tr');
    
    titleEn.addEventListener('blur', function() {
        if (this.value && !titleTr.value) {
            titleTr.value = this.value + ' (T√ºrk√ße)';
        }
    });
    
    titleTr.addEventListener('blur', function() {
        if (this.value && !titleEn.value) {
            titleEn.value = this.value + ' (English)';
        }
    });
}

// Initialize on load
document.addEventListener('DOMContentLoaded', function() {
    setupTitleSync();
});
</script>
{% endblock %}