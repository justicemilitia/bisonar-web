{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-gray-50 dark:bg-gray-900 py-8">
    <div class="container mx-auto px-6 max-w-4xl">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
                {% if post %}Edit Post{% else %}New Post{% endif %}
            </h1>
            <p class="text-gray-600 dark:text-gray-400">
                {% if post %}Update your blog post{% else %}Create a new blog post{% endif %}
            </p>
        </div>

        <!-- AI Generation Section - SADECE YENƒ∞ POST ƒ∞√áƒ∞N G√ñSTER -->
        {% if not post %}
        <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-6 mb-6">
            <h3 class="text-lg font-semibold text-blue-900 dark:text-blue-100 mb-2">
                üöÄ AI ile Blog Yazƒ±sƒ± Olu≈ütur
            </h3>
            <p class="text-blue-700 dark:text-blue-300 mb-4">
                Konuyu girerek AI destekli blog yazƒ±sƒ± olu≈üturabilirsiniz.
            </p>
            
            <div class="flex flex-col md:flex-row gap-4">
                <input type="text" id="ai-topic" 
                       placeholder="√ñrn: n8n workflow optimization, ChatGPT entegrasyonu..."
                       class="flex-1 px-3 py-2 border border-blue-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                
                <select id="ai-language" class="px-3 py-2 border border-blue-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                    <option value="en">English</option>
                    <option value="tr" selected>T√ºrk√ße</option>
                </select>
                
                <button onclick="generateWithAI()" 
                        class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md font-semibold transition-colors flex items-center gap-2">
                    <span id="ai-loading" class="hidden">‚è≥</span>
                    AI ile Olu≈ütur
                </button>
            </div>
            <div id="ai-error" class="text-red-600 dark:text-red-400 mt-2 hidden"></div>
        </div>
        {% endif %}

        <!-- Form - DEƒûƒ∞≈ûMEDƒ∞ -->
        <form method="POST" enctype="multipart/form-data" class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 space-y-6">
            <!-- Title -->
            <div>
                <label for="title" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Title *
                </label>
                <input type="text" id="title" name="title" value="{{ post.title if post }}" 
                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                       required>
            </div>

            <!-- Slug -->
            <div>
                <label for="slug" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Slug *
                </label>
                <input type="text" id="slug" name="slug" value="{{ post.slug if post }}" 
                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                       required>
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">URL-friendly version of the title</p>
            </div>

            <!-- Excerpt -->
            <div>
                <label for="excerpt" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Excerpt *
                </label>
                <textarea id="excerpt" name="excerpt" rows="3"
                          class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                          required>{{ post.excerpt if post }}</textarea>
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Brief description for preview</p>
            </div>

            <!-- Content -->
            <div>
                <label for="content" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Content *
                </label>
                <textarea id="content" name="content" rows="15"
                          class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white font-mono text-sm"
                          required>{{ post.content if post }}</textarea>
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Markdown supported</p>
            </div>

            <!-- Author & Read Time -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="author" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Author *
                    </label>
                    <input type="text" id="author" name="author" value="{{ post.author if post else 'Bisonar Team' }}" 
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                           required>
                </div>
                <div>
                    <label for="read_time" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Read Time *
                    </label>
                    <input type="text" id="read_time" name="read_time" value="{{ post.read_time if post else '5 min read' }}" 
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                           required>
                </div>
            </div>

            <!-- Image -->
            <div>
                <label for="image" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Featured Image
                </label>
                {% if post and post.image_url %}
                <div class="mb-4">
                    <img src="{{ post.image_url }}" alt="Current image" class="h-32 w-auto rounded-lg">
                    <input type="hidden" name="current_image" value="{{ post.image_url }}">
                </div>
                {% endif %}
                <input type="file" id="image" name="image" 
                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700"
                       accept="image/*">
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">PNG, JPG, GIF up to 5MB</p>
            </div>

            <!-- Publish -->
            <div class="flex items-center">
                <input type="checkbox" id="is_published" name="is_published" 
                       {% if post and post.is_published or not post %}checked{% endif %}
                       class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                <label for="is_published" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">
                    Publish immediately
                </label>
            </div>

            <!-- Actions -->
            <div class="flex justify-end space-x-4 pt-6 border-t border-gray-200 dark:border-gray-700">
                <a href="{{ url_for('admin_dashboard') }}" class="px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                    Cancel
                </a>
                <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md font-semibold transition-colors">
                    {% if post %}Update Post{% else %}Create Post{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Auto-generate slug from title - DEƒûƒ∞≈ûMEDƒ∞
document.getElementById('title').addEventListener('input', function() {
    const slugInput = document.getElementById('slug');
    if (!slugInput.value) {
        const slug = this.value
            .toLowerCase()
            .replace(/[^a-z0-9 -]/g, '')
            .replace(/\s+/g, '-')
            .replace(/-+/g, '-');
        slugInput.value = slug;
    }
});

// AI Generation Function - BASƒ∞T VE √áALI≈ûAN VERSƒ∞YON
async function generateWithAI() {
    const topicInput = document.getElementById('ai-topic');
    const languageSelect = document.getElementById('ai-language');
    const loadingElement = document.getElementById('ai-loading');
    const errorElement = document.getElementById('ai-error');
    
    const topic = topicInput.value.trim();
    const language = languageSelect.value;
    
    if (!topic) {
        errorElement.textContent = 'L√ºtfen bir konu girin';
        errorElement.classList.remove('hidden');
        return;
    }
    
    loadingElement.classList.remove('hidden');
    errorElement.classList.add('hidden');
    
    try {
        console.log('üîÑ Sending AI request...', { topic, language });
        
        const response = await fetch('/admin/generate-blog', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                topic: topic,
                language: language
            })
        });
        
        console.log('üì• Response status:', response.status);
        console.log('üì• Response ok:', response.ok);
        
        const data = await response.json();
        console.log('üì• Full response data:', data);
        
        if (response.ok) {
            if (data.error) {
                console.log('‚ùå Backend error:', data.error);
                throw new Error(data.error);
            } else {
                console.log('‚úÖ AI data received:', {
                    title: data.title,
                    content_length: data.content?.length,
                    success: data.success
                });
                
                // Fill form with AI generated content
                document.getElementById('title').value = data.title || '';
                document.getElementById('slug').value = data.slug || data.title
                    .toLowerCase()
                    .replace(/[^a-z0-9 -]/g, '')
                    .replace(/\s+/g, '-')
                    .replace(/-+/g, '-');
                document.getElementById('excerpt').value = data.excerpt || '';
                document.getElementById('content').value = data.content || '';
                document.getElementById('read_time').value = data.read_time || '5 min read';
                document.getElementById('author').value = data.author || 'Bisonar AI';
                
                // Show success message
                errorElement.textContent = '‚úÖ AI i√ßeriƒüi ba≈üarƒ±yla olu≈üturuldu!';
                errorElement.classList.remove('hidden');
                errorElement.classList.remove('text-red-600');
                errorElement.classList.add('text-green-600');
                
                console.log('üéâ Form filled successfully');
            }
            
        } else {
            console.log('‚ùå HTTP error:', data);
            throw new Error(data.error || `HTTP ${response.status} - AI servisi ≈üu anda m√ºsait deƒüil`);
        }
        
    } catch (error) {
        console.error('‚ùå AI generation error:', error);
        errorElement.textContent = 'Hata: ' + error.message;
        errorElement.classList.remove('hidden');
        errorElement.classList.remove('text-green-600');
        errorElement.classList.add('text-red-600');
    } finally {
        loadingElement.classList.add('hidden');
    }
}
</script>
{% endblock %}